---
title: "LinearModel"
author: "Huize Zhang"
date: "03/12/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(splines)
library(tidyverse)
library(ggplot2)
library(purrr)
library(broom)

```


```{r}
# loading data
Federer <- extract_records_all("data/2017-ausopen-matches.csv", 
                               "data/2017-ausopen-points.csv", "Roger Federer")
Nadal = extract_records_all("data/2017-ausopen-matches.csv",
                            "data/2017-ausopen-points.csv", "Rafael Nadal")
Alex =extract_records_all("data/2017-ausopen-matches.csv",
                          "data/2017-ausopen-points.csv", "Alexander Zverev")
Raonic <- extract_records_all("data/2017-ausopen-matches.csv",
                          "data/2017-ausopen-points.csv", "Milos Raonic")
```


```{r}
# function for linear model 
fit <- function(data) lm(Speed_KMH~index_point,data = data)

# create a list of dataset interested 
player_dt<- list(Federer, Nadal, Alex, Raonic)

# create a list of player's name
name <- list("Roger Federer","Rafael Nadal", "Alexander Zverev","Milos Raonic")

# clean the data: filter out DoubleFault and rows serve by the player interested 
clean_data<- function(dt, name) {
  dt %>% filter(Speed_KMH != 0) %>% 
    filter(ServeIndicator == ifelse(player1 == name, 1,2)) %>% 
    mutate(name = name)
}

# clean the palyer_dt
player_dt <- map2_df(player_dt, name, clean_data)

# build linear model
by_player <- player_dt %>% 
  group_by(name, index_set) %>% 
  nest() %>% 
  mutate(model = map(data, fit)) 

# extrac the intercept and slope of the linear model
player_coef <- by_player %>%   
  unnest(model %>% map(tidy))%>% 
  select(name, index_set, term, estimate) %>% 
  spread(term, estimate)

player_model <- by_player %>% unnest(model %>% map(augment))

ggplot(player_model, 
       aes( x = index_point, y=Speed_KMH)) +
  geom_point(alpha = 0.5, size = 0.5) +
  geom_smooth(method = "lm") + 
  facet_wrap(~name) 

# produce fitness statistics
player_fit <- by_player %>% unnest(model %>% map(glance))
# visualise r.squared 
ggplot(player_fit,aes(x= r.squared)) + 
  geom_histogram()
# from here we can see that a linear model doesnt fit well for the serving speed 

badfit <- player_fit %>% filter(r.squared < 0.1)
player_dt_2 <- player_dt %>% filter(index_set %in% badfit$index_set)
ggplot(player_dt_2, aes(y= Speed_KMH, x = index_point)) + 
  geom_point() +
  facet_wrap(~name) + 
  geom_smooth(method = "lm")
 

```

