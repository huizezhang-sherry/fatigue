---
title: "LinearModel"
author: "Huize Zhang"
date: "03/12/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(ggplot2)
library(purrr)
library(broom)
library(gridExtra)
library(lme4)
library(tidyverse)
library(broom)
library(mice)
```

# Extracting data 

```{r}
# loading data
Federer <- extract_records_all("data/2017-ausopen-matches.csv", 
                               "data/2017-ausopen-points.csv", "Roger Federer")
Nadal = extract_records_all("data/2017-ausopen-matches.csv",
                            "data/2017-ausopen-points.csv", "Rafael Nadal")
Alex =extract_records_all("data/2017-ausopen-matches.csv",
                          "data/2017-ausopen-points.csv", "Alexander Zverev")
Raonic <- extract_records_all("data/2017-ausopen-matches.csv",
                          "data/2017-ausopen-points.csv", "Milos Raonic")
```

# dealing with missing distance
```{r}
# Match 1601 (Federer) and 1602 (Nadal) has missing distance of more than 40% (1601: 48%, 1602: not available at all) - drop the match 
Nadal <- Nadal %>% filter(match_num != 1602) 
Federer <- Federer %>% filter(match_num != 1601)
```


# Functions to use

```{r functions_used}
# clean the data: adding new variables created by functions in R folder 
fill_in_miss <- function(dt) {
  dt %>%
    mutate(dist = ifelse(dist ==0, NA, dist)) %>% 
    select(dist,match_num,SetNo, GameNo, PointNumber)
  dt_mice <- mice(dt)
  dt_mice <- complete(dt_mice)
  dt <- dt %>% mutate(dist = dt_mice$dist)
  return(dt)
}

clean_data<- function(dt, name) {
  dt %>% 
    mutate(name = name) %>% 
    mutate(rest = as.factor(rest(dt))) %>% 
    mutate(impt = point_impt(dt)) %>% 
    # filter the double fault points
    filter(Speed_KMH != 0) %>%  
    # filter the point serve by the player interested 
    filter(ServeIndicator == ifelse(player1 == name, 1,2)) %>% 
    select(PointNumber,impt,dist,cum_dist,rest,time,MatchNo, 
           ServeNumber, name, Speed_KMH, cum_time)
}

# linear model 
fit_lm <- function(data) lm(Speed_KMH~ 
                              PointNumber+ impt + cum_dist + rest + MatchNo +
                              PointNumber * MatchNo,
                            data = data)
# point number and elasped time are highly correlated - drop one 

# mixed effect model 
fit_lmer <- function(data) lmer(Speed_KMH~
                                  PointNumber + impt + cum_dist + rest +
                                  (1|MatchNo), 
                                data = data)

build_linear_model <- function(dt, fit){
  by_player_fit <- dt %>% 
    group_by(name) %>% 
    nest() %>% 
    mutate(model = map(data, fit)) 
  return(by_player_fit)
}

fetch_coef <- function(dt){
  player_coef_fit <- dt %>%
    unnest(model %>% map(tidy)) %>%
    select(name, term,estimate) %>%
    spread(term, estimate)
}
```

# Modelling 

```{r compute_models}
# create a list of dataset interested 
player_dt<- list(Federer, Nadal, Alex, Raonic)

# create a list of player's name
name <- list("Roger Federer","Rafael Nadal", "Alexander Zverev","Milos Raonic")

# multiple imputation for missing distance 
player_dt_miss <- map(player_dt,fill_in_miss)

# clean the palyer_dt
player_dt_clean <- map2_df(player_dt_miss, name, clean_data)

# split by first and second serve 
player_dt_serve <- split(player_dt_clean,player_dt_clean$ServeNumber)
firstServe <- player_dt_serve[[1]] 
SecondServe <- player_dt_serve[[2]]

# model for first serve for all four players
firstserve_lm <- build_linear_model(firstServe, fit_lm) %>% 
  mutate(servenumber =as.factor(1)) 
firstserve_lmer <- build_linear_model(firstServe, fit_lmer) %>% 
  mutate(servenumber =as.factor(1))
firstserve_coef <- firstserve_lm%>% fetch_coef()
firstserve_aug_lm <- firstserve_lm %>% unnest(model %>% map(augment))
firstserve_aug_lmer <- firstserve_lmer %>% unnest(model %>% map(augment))
firstserve_fit_lm <- firstserve_lm %>% unnest(model%>% map(glance))


# model for first serve for all four players
secondserve_lm <- build_linear_model(SecondServe, fit_lm) %>%
  mutate(servenumber =as.factor(2))
secondserve_lmer <- build_linear_model(SecondServe, fit_lmer) %>% 
  mutate(servenumber =as.factor(2))
secondserve_coef_lmer <- fetch_coef(secondserve_lmer)
secondserve_aug_lm <- secondserve_lm %>% unnest(model %>% map(augment))
secondserve_aug_lmer <- secondserve_lmer %>% unnest(model %>% map(augment))
secondserve_fit<- secondserve_lm %>% unnest(model%>% map(glance))

# augment first and second serve data together 
model_lm<- rbind(firstserve_aug_lm, secondserve_aug_lm) 
model_lmer<- rbind(firstserve_aug_lmer, secondserve_aug_lmer) 


```

# Visualisation 

## Comparision of lm and lmer 
The linear model and mixed effect doesn't differentiate  much in a sense that the difference between the predicted value is mostly within -5 and 5 KMH. 
```{r}
predict <- cbind(model_lm$.fitted,model_lmer$.fitted)
diff <- as.data.frame(predict[,2]-predict[,1])
ggplot(diff, aes(x=`predict[, 2] - predict[, 1]`)) + geom_histogram()

```



## Predicted vs. Actual 
This graph contrasts the player's servign speed with the predicted value. The blue line has slope of 1, which is the position where a perfect prediction lays. The two clusters indicates the effectiveness of prediction when seperating the first and second serve in modelling. For Federer, Nadal and Zeverev, the difference between first and second serve is clear as shown in mainly two clusters, while Raonic, as a big server doesn't seem to have clear cut between the first and second serve speed. 

```{r}
p1 <- ggplot(model_lm, aes(x = Speed_KMH, y = .fitted, col = MatchNo))+ 
  geom_point(alpha = 0.8, sie = 0.5) +
  facet_grid(name~MatchNo) +
  geom_abline(slope = 1, intercept = 0, col = "blue") + 
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  ggtitle("Linear Model")

p2 <- ggplot(model_lmer, aes(x = Speed_KMH, y = .fitted, col = MatchNo))+ 
  geom_point(alpha = 0.8, sie = 0.5) +
  facet_grid(name~MatchNo) +
  geom_abline(slope = 1, intercept = 0, col = "blue") + 
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  ggtitle("Mix Effect Model")

grid.arrange(p1,p2, nrow = 1)
```

# X-axis
The correlation between Point Number and cummulated match time is high and the plot shows the relationship is linear. Thus it doesn't matter much to use point number or match time as x variable when plotting the models.

```{r correlation}
player_dt_clean %>% ggplot(aes(x = PointNumber, y = cum_time)) +
  geom_line() +
  facet_grid(name~MatchNo)

cor(player_dt_clean$PointNumber, player_dt_clean$cum_time)

```

## Point Number 
For all players, their first serves are significantly faster than the second serve speed, which again, demonstrates the necessity of seperating first and second serve when building the model. For the first serve, Zeverev and Raonic have their serving speeds mostly above 175 KMH, which are much higher than those of Nadal or Federer's. Notice that Nadal does have a few fast serve at around 200 KMH. 

For the second serve, Zeverev shows clear evidence of reduce of speed for each match and this could be due to the fact of his young age, thus lack of experience or fatigue. For Raonic, we can find some evidence of reduce of serving speed but the variation of serve varies a lot for each match. For Nadal and Federer, whose serving speed is consistent across game, fatigue can be captured by the variation of the serving speed. 

Based on these, we could capture the fatigue through the reduce of the serving speed (slope) as well as the variation of the serving speed (variance). Attention need to be paid to players like Raonic, whose serving naturally variate much in each match. 

```{r analysis}
p3 <- ggplot(subset(model_lmer, servenumber ==1), 
             aes(x = PointNumber, y=.fitted, col = MatchNo)) +
  geom_point(alpha = 0.8, size = 0.8) +
  facet_grid(name~MatchNo, scales = "fixed") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(limits = c(120, 220)) +
  ggtitle("FirstServe-lmer")

p4 <- ggplot(subset(model_lmer, servenumber ==2), 
             aes( x = PointNumber, y=.fitted, col = MatchNo)) +
  geom_point(alpha = 0.8, size = 0.8) +
  facet_grid(name~MatchNo, scales = "fixed") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(limits = c(120, 220)) +
  ggtitle("SecondServe-lmer")

grid.arrange(p3, p4, nrow = 1)
```

# Running Distance 
```{r}
p5 <- ggplot(subset(model_lmer, servenumber ==1), 
             aes(x = cum_dist, y=.fitted, col = MatchNo)) +
  geom_point(alpha = 0.8) +
  facet_grid(name~MatchNo, scales = "free_x") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(limits = c(120, 220)) +
  ggtitle("FirstServe-lmer")


p6 <- ggplot(subset(model_lmer, servenumber ==2), 
             aes( x = cum_dist, y=.fitted, col = MatchNo)) +
  geom_point(alpha = 0.8) +
  facet_grid(name~MatchNo, scales = "free_x") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(limits = c(120, 220)) +
  ggtitle("SecondServe-lmer")

grid.arrange(p5, p6, nrow = 1)
```


# point importance 
- In general, point importance doesn't affect the serving speed very much. 
- For Raonic's second serve, serving speeds decrease as point becomes more importance, which can be viewed as a conservative approach taken by him. 
- For Federer's first serve, serving speeds increase, which shows an opposite strategy taken by Federer when points get more important
- no need to seperate the point importance by players for fatigue index 

```{r}
p7 <- ggplot(subset(model_lmer, servenumber ==1), 
             aes(x = impt, y=.fitted, col = MatchNo)) +
  geom_point(alpha = 0.8) +
  facet_grid(name~MatchNo, scale = "free_x") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(limits = c(120, 220)) +
  ggtitle("FirstServe-lmer")

p8 <- ggplot(subset(model_lmer, servenumber ==2), 
             aes( x = impt, y=.fitted, col = MatchNo)) +
  geom_point(alpha = 0.8) +
  facet_grid(name~MatchNo, scale = "free_x") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(limits = c(120, 220)) +
  ggtitle("SecondServe-lmer")

grid.arrange(p7, p8, nrow = 1)
```


# rest
In general, after having the game break, players tends to have higher serving speed, which indicates less fatigue. The improvement for Federer and Nadal is marginal while for Zeverev, the increase is much more obvious. Raonic's behaviour is interesting in a sense that after each game break, his serving usually drop (green dots) while after the set break, he would have faster serving (blue dotss)

```{r}
p9 <- ggplot(subset(model_lmer, servenumber ==1), 
             aes(x = PointNumber, y=.fitted, shape = rest,col = as.factor(rest))) +
  geom_point(alpha = 0.8) +
  facet_grid(name~MatchNo, scale = "free_x") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(limits = c(120, 220)) +
  ggtitle("FirstServe-lmer")

p10 <- ggplot(subset(model_lmer, servenumber ==2), 
             aes( x = PointNumber, y=.fitted, shape = rest,col = as.factor(rest))) +
  geom_point(alpha = 0.8) +
  facet_grid(name~MatchNo, scale = "free_x") +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45)) +
  scale_y_continuous(limits = c(120, 220)) +
  ggtitle("SecondServe-lmer")

grid.arrange(p9, p10, nrow = 1)
```

# MatchNo

```{r}
ggplot(subset(model_lmer, servenumber==1), 
       aes(x = PointNumber, y = .fitted, group = name, col = MatchNo)) +
  geom_line() + 
  facet_grid(name~MatchNo)




fit_lm <- function(data) lm(Speed_KMH~ 
                              PointNumber(done)+ 
                              impt(done) + 
                              dist(missing) + 
                              rest(done) + 
                              time + 
                              cum_time(should we put both if high correlation?) + 
                              MatchNo (doesnt look useful for each round ) + 
                              PointNumber * MatchNo,
                            data = data)
```

