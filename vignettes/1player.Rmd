---
title: "07112018"
author: "Huize Zhang"
date: "07/11/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r select_data, fig.height=15}
library(readr)
library(tidyverse)
library(plyr)


match17 <- read_csv("data/2017-ausopen-matches.csv")
points17<- read_csv("data/2017-ausopen-points.csv")

dt <- left_join(points17,match17)
dt <- dt %>% mutate(Gender = as.factor(ifelse(test = match_num <2000,yes = 'Male',no = 'Female')))

# left_join: keep all the left + new from right if match 
# right_join:
# inner_join: keep the info in both 

## max(table(dt$player1))
## dt$player1
## player <- table(dt$player1)
## sort(player,decreasing = TRUE)



# extract the top players for male and female: gender= 1 if male, 2 if female
top_player <- function(gender,n=10){
  
  p1 <- dt %>% 
    dplyr::select(player1,Gender) %>% 
    filter(Gender == gender) %>% 
    mutate(player1 = as.factor(player1)) %>% 
    # consider each player
    group_by(player1) %>% 
    # count how many rows
    tally() %>%
    arrange(desc(n))
  
    
  p2 <- dt %>% 
    dplyr::select(player2,Gender) %>% 
    filter(Gender == gender) %>% 
    mutate(player2 = as.factor(player2)) %>% 
    # consider each player
    group_by(player2) %>% 
    # count how many rows
    tally() %>%
    arrange(desc(n))
    
    

  colnames(p1) <- c("player", "count1")
  colnames(p2) <- c("player", "count2")
  
  player<- full_join(p1,p2, by="player")
  player$count2[is.na(player$count2)] <- 0
  player$count1[is.na(player$count1)] <- 0
  
  player <- player %>% 
    mutate(count = count1 + count2) %>% 
    #select only the columns needed: player & count
    dplyr::select(player,count) %>% 
    #arrange by count
    arrange(desc(count)) %>% 
    filter(!is.na(player)) %>%   
    # select the top n as per argument 
    top_n(n)

  return(player)
}

male_player <- top_player("Male",20)
female_player <- top_player("Female",10)


extract_records <- function(name){
  df1 <- dt[dt$player1 == name,]
  df2 <- dt[dt$player2 == name,]
  df <- rbind(df1,df2)
  return(df)
}


# extract records for Federer
RF_all <- extract_records("Roger Federer")
RF_all <- RF_all[!is.na(RF_all$match_id),]
RF_all <- RF_all %>% mutate(Position = as.integer(ifelse(player1 == "Roger Federer", 1,2))) %>% 
  arrange(match_num)
RF_all <- RF_all %>% filter(RF_all$ServeIndicator == RF_all$Position)
RF_all <- RF_all %>% filter(as.factor(RF_all$ServeNumber) != 0) 
RF <-  RF_all %>% 
  mutate(Count = seq(1,length(RF_all$SetNo),1)) %>% 
  mutate(Round = as.factor((RF_all$match_num - 1000) %/% 100)) %>% 
  mutate(match_num = as.factor(RF_all$match_num))
RF_all$player2  

# Extract DoubleFault data



```

```{r sample trial, fig.height=15}
# sample for trial
rf <- RF %>% filter(match_num == 1112)

library(ggplot2)
rf %>% filter(PointServer == 2) %>% dplyr::select(ElapsedTime,Speed_KMH) %>% plot()

ggplot(rf,aes(x=Count, y=Speed_KMH)) + 
  geom_point() 

ggplot(subset(rf,rf$SetNo == 4),aes(x=Count,y=Speed_KMH,col = match_num)) +
  ylim(120,220)+
  geom_point() +
  geom_smooth(aes(group = SetNo))  


```

```{r Double_Fault}
DoubleFault<- RF_all %>% filter(RF_all$ServeNumber == 0)
DoubleFault <- DoubleFault %>% 
  mutate(Count = seq(1,length(DoubleFault$SetNo),1)) %>% 
  mutate(Round = (DoubleFault$match_num -1000) %/% 100)

# Double Fault
ggplot(DoubleFault,aes(x = SetNo, fill = as.factor(SetNo))) +
  geom_bar(aes(group = SetNo)) +
  facet_wrap(~Round, nrow = 2)

```

Plot 1: This plot shows the serving speed of Federer in 2017 Australia Open by serving number. We can see that the speed of first and second serve is considerably different from each other, which motivates us to seperate the first and second serve data for modelling fatigue
```{r, fig.height=15, fig.cap=" this is a chart"}
library(visdat)
ggplot(RF,aes(x=Count,y=Speed_KMH,col= match_num)) +
  ylim(min(RF$Speed_KMH),max(RF$Speed_KMH))+
  geom_point() +
  facet_grid(~ServeNumber,scales = "free_x") + 
  scale_y_continuous("Speed (KPH)", breaks = scales::pretty_breaks(n = 10)) +
	scale_x_continuous("Serve Count", breaks = scales::pretty_breaks(n = 10)) + 
  theme(legend.position = "right", text = element_text(size = 16)) + 
  ggtitle("Roger Federer Serving Speeds (Aus Open 2017)")
```

```{r}
# density plot for all
ggplot(RF,aes(x=Speed_KMH,col = Round)) +
  ylim(min(RF$Speed_KMH),max(RF$Speed_KMH))+
  geom_density() +
  facet_wrap(~ServeNumber, ncol = 1, scales = "free_x") + 
  scale_y_continuous("Frequency", breaks = scales::pretty_breaks(n = 10)) +
	scale_x_continuous("Speed (KPH)", breaks = scales::pretty_breaks(n = 10)) + 
  theme(legend.position = "right", text = element_text(size = 16)) + 
  ggtitle("Roger Federer Serving Speeds (Aus Open 2017)")
```


```{r,fig.height=15}
# density plot for Second Serve & Round = c(2,4,6)
ggplot(subset(RF,(ServeNumber == 2)&(Round == c(2,4,6))),
       aes(x=Speed_KMH,col = Round)) +
  ylim(min(RF$Speed_KMH),max(RF$Speed_KMH))+
  geom_density(aes(fill = Round), alpha = 0.25) +
  scale_y_continuous("Frequency", breaks = scales::pretty_breaks(n = 10)) +
	scale_x_continuous("Speed (KPH)", breaks = scales::pretty_breaks(n = 10)) + 
  theme(legend.position = "right", text = element_text(size = 16)) + 
  ggtitle("Roger Federer Second Serving Speeds (Aus Open 2017)")
#########ignore for the time being ############
# match #1601 game 3, Federer suffered from break twice  


#####From the plot, we can see that serving speed may not necessarily indicate whether Federer is fatigue or not. In the third game of the 4th round (match #1402), Federer won consecutively 6 games against Nishikori and finished at 6:1. From the plot, his serve speed reduced from approximately 185 KMH to 165 KMH. This reduction of speed can be viewed as a strategy to save energy when Federer broke two serving games of Nishikori. Similar behaviour is also shown in match #1112, game 3,  match #1402, game 3. 

#####- May be indicator of fatigue at 1206 end of the first game 
#####3- increase of serving speed could because of multiple ADs  - strategy # 1303 game 3 (the inflection point)
#####  - but serving speed could reduce because of the same factor - # 1402, game 3 

```

## Reading from reference  
### Volume-dose model 
- The volume-dose model represents the monotonically increasing relationship between the workload $x_{jt}$ of player j on day t and the dose $d_{jt}$ of fatigue-inducing toxin administered to the player on that day. 

- $x_{jt}$ is the number of pitches thrown by a reliever during an appearance on day t.

- Assume doesn't vary with players ? doubt about that: age, running speed, mode in the season, different type of ground

- Linear spline: generalised additive model 

### Dose-response model 
- The dose-response model estimates the monotonically decreasing relationship between the concentration of the toxin $c_{jt}$ and the playerâ€™s corresponding response $v_{jt}$ . 

- In the reference paper, the auther uses a linear model. More model like log-logistic, log-normal and Weibull distribution are also popular in other literature 



## Match& Set Break rule 
Players can take 90-second changeover breaks during a game and 120 seconds between sets. (https://www.livestrong.com/article/142038-tennis-rules-switching-sides/)

```{r model}
# Volumn-dose model 
library(splines)

vd_ns <- lm(Speed_KMH~bs(Count, df= 2), data = RF[RF$ServeNumber == 1,])
fit_ns_1 <- fitted(lm(Speed_KMH~ns(Count, df= 2), data = RF))

vd_sp <- smooth.spline(RF[RF$ServeNumber == 2,]$Speed_KMH~RF[RF$ServeNumber == 2,]$Count, cv = TRUE)
fit_sp <- fitted(smooth.spline(RF$Speed_KMH~RF$Count, df= vd_sp$df))

mon_sp <- spline(RF$speed_KMH, method = "hyman")


# Create a vector for knots
knots = c()
for(i in seq(1,7,1)){
  knots[i] <- RF$Count[RF$Round ==i][1]
}
knots[8] <- range(RF$Count)[2]
knots


bs <- lm(Speed_KMH~bs(Count, df= 2, knots = knots), data = RF)
bs$fitted.values

bs_1 <- lm(Speed_KMH~bs(Count, df= 2, knots = knots), data = RF[RF$ServeNumber ==1,])
bs_1$fitted.values

bs_2 <- lm(Speed_KMH~bs(Count, df= 2, knots = knots), data = RF[RF$ServeNumber ==2,])
bs_2$fitted.values


# monotonic spline 
x = RF$Count
y = RF$Speed_KMH
dt <- data.frame(x,y)
cr <- gam(y~s(x,k=10,bs="cr"), data = RF[RF$ServeNumber == 1,])
sm <- smoothCon(s(x,bs="cr"),dt,knots = NULL)[[1]]
F <- mono.con(sm$xp, up = TRUE)
G <- list(X=sm$X,C=matrix(0,0,0),sp=cr$sp,p=sm$xp,y=y,w=y*0+1)
p <- pcls(G)

library(cobs)
fit_cbs_match=c()
for (i in levels(RF$match_num)){
  cbs <-  cobs(y = RF[(RF$ServeNumber == 2)&(RF$match_num==i),]$Speed_KMH, 
               x=RF[(RF$ServeNumber == 2)&(RF$match_num==i),]$Count,
             constraint= "increase")
  for (j in RF[(RF$ServeNumber == 2)&(RF$match_num==i),]$Count){
    fit_cbs_match[j]<-predict(cbs,z =j)[,2]
  } 
}
 

fit_cbs_match
fit_cbs_match <- fit_cbs_match[!is.na(fit_cbs_match)]
plot(fit_cbs_match)


fit_cbs_set = c()
for (i in levels(as.factor(RF$SetNo))){
  cbs <-  cobs(y = RF[(RF$ServeNumber == 2)&(RF$SetNo==i),]$Speed_KMH, 
               x=RF[(RF$ServeNumber == 2)&(RF$SetNo==i),]$Count,
             constraint= "increase")
  for (j in RF[(RF$ServeNumber == 2)&(RF$SetNo==i),]$Count){
    fit_cbs_set[j]<-predict(cbs,z =j)[,2]
  } 
}


fit_cbs_set
fit_cbs_set <- fit_cbs_set[!is.na(fit_cbs_set)]
set <- cbind(RF[(RF$ServeNumber == 2),]$SetNo, fit_cbs_set)
summary(set)
plot(fit_cbs_set)

summary(fit_s)

cbs <-  cobs(y = RF[(RF$ServeNumber ==2)&(RF$SetNo==3),]$Speed_KMH, 
               x= RF[(RF$ServeNumber ==2)&(RF$SetNo==3),]$Count,
             constraint= "increase")
fit_s<- predict(cbs,z =RF[(RF$ServeNumber == 2)&(RF$SetNo==3),]$Count)
plot(fit_s)



ggplot(subset(RF,ServeNumber == 2),aes(x=Count,color = Round)) +
  geom_point(aes(y=Speed_KMH),size = 2) +
  geom_line(aes(y=fit_cbs_match), size = 2) +
  scale_y_continuous("Speed (KPH)", breaks = scales::pretty_breaks(n = 20)) +
	scale_x_continuous("Count", breaks = scales::pretty_breaks(n = 10)) + 
  theme(legend.position = "right", text = element_text(size = 16)) + 
  ggtitle("Roger Federer Second Serving Speeds (Aus Open 2017)")

ggplot(subset(RF,(ServeNumber == 2)),aes(x=Count, y=fit_cbs_set,col = SetNo)) +
  geom_line()+
  facet_wrap(~SetNo)+
  scale_y_continuous("Speed (KPH)", breaks = scales::pretty_breaks(n = 10)) +
	scale_x_continuous("Count", breaks = scales::pretty_breaks(n = 10)) + 
  theme(legend.position = "right", text = element_text(size = 16)) + 
  ggtitle("Roger Federer Second Serving Speeds (Aus Open 2017)")
  
  
library(mgcv)
ggplot(subset(RF,(ServeNumber == 2)),aes(x=Count,y = Speed_KMH, col = Round)) +
  geom_point(size = 2) +
  #geom_smooth(se = FALSE)+
  #geom_smooth(method = "lm", formula = y~bs(x, df= 3))+
  #geom_smooth(method = "gam", formula = y~s(x, m=2)) + 
  #geom_smooth(method = "lm", formula = y~ns(x, df= 2)) +
  scale_y_continuous("Speed (KPH)", breaks = scales::pretty_breaks(n = 20)) +
	scale_x_continuous("Count", breaks = scales::pretty_breaks(n = 10)) + 
  theme(legend.position = "right", text = element_text(size = 16)) + 
  ggtitle("Roger Federer Second Serving Speeds (Aus Open 2017)")


```

```{r model}
# dose-response model
library(ggfortify)
library(urca)
Speed <- ts(RF$Speed_KMH)
Speed %>% autoplot()

Speed %>% diff() %>% ur.kpss()
Speed %>% diff() %>% autoplot()


### drc fails because of convergence reason 
library(drc)
fit_0 <-  drm(Speed_KMH~Count,data =RF[RF$ServeNumber ==2,],fct = LL.4()) 
summary(fit_0)
mselect(fit_0, list(LL.3(), LL.5(), W2.4()))
plot(fit_0) + 
  scale_x_continuous("Serve Count", breaks = scales::pretty_breaks(n = 10))



library(dr4pl)
dr <- dr4pl(Speed_KMH~Count, data = RF[RF$ServeNumber ==2,])
plot(dr) + 
  scale_x_continuous("Serve Count", breaks = scales::pretty_breaks(n = 10))
print(dr$parameters)
```


```{r}

```

