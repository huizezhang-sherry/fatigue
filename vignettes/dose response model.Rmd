---
title: "Dose Response Model"
author: "Huize Zhang"
date: "23/11/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(drc)
library(sandwich)
library(lmtest)
```

```{r}
# reproduce Steph's work
# fatigue_predict <- function(data, serve, the_game){
#   # data <- subset(data, ServeNumber == serve & game == the_game)
#   
#   fit <- drm(log(Speed_KMH) ~ Set, 
#              data = data,
#              fct = W1.4())
#   
#   data.frame(
#     game = paste("game", data$game[1]),
#     ServeNumber = ifelse(serve == 1, "First Serve", "Second Serve"),
#     Speed = c(data$Speed_KMH, exp(predict(fit))),
#     Type = rep(c("Actual","Predicted"), each = nrow(data))
#   )
# }	
# 
# params <- expand.grid(game = unique(f$game), serve = 1:2)
# model <- fatigue_predict(f,params$serve,params$game)

```

The current problem faced when fitting a dose-response model is that the evidence of fatigue (reduction of serving speed) is not very obvious. For the three set of data manipulated below, only the second df produce a downward sloping dose-response curve. 
```{r}
df <- Federer %>% group_by(game) %>% 
  dplyr::select(game,Speed_KMH) %>% 
  summarise(mean_speed = mean(Speed_KMH)) 

# df<- Federer %>% group_by(game) %>% 
#   filter(SetNo ==5) %>% 
#   dplyr::select(game,Speed_KMH) %>% 
#   filter(Speed_KMH != 0)%>% 
#   summarise(mean_speed = mean(Speed_KMH)) %>% 
#   filter(game > 150 & game <240) %>% mutate(game = game - 213) 
# 
# df <- Federer %>% group_by(game) %>% 
#   filter(SetNo ==5) %>% 
#   dplyr::select(game,Speed_KMH) %>% 
#   filter(Speed_KMH != 0)%>% 
#   summarise(mean_speed = mean(Speed_KMH)) %>% 
#   filter(game > 250) %>% mutate(game = game - 257)



```

Dose-response model via drc package
```{r}
model <- drm(df$mean_speed~df$game, fct = LL.4())
summary(model)
# adjust the std. error by sandwich package
coeftest(model, vcov = sandwich)
ED(model, 50, interval = "delta")
plot(model, broken = TRUE, type = "all", xlim = c(1, 20))
plot(df$game, predict(model))

```

dr4pl also produces dose-response model as drc package. It sometimes works better than drc when there's convergence problem with drc
```{r}
library(dr4pl)
m <- dr4pl(response = log(df$mean_speed), dose = df$game, method.init = "logistic", trend = "decreasing")
summary(m)
plot(m)
plot(MeanResponse(x = df$game,theta = m$parameters))
values <- IC(m, c(95,90,85))
values

```

